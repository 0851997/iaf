<module>
	<adapter name="WebControlGenerateFlowDiagram_Process">
		<receiver className="nl.nn.adapterframework.receivers.GenericReceiver"
			name="WebControlGenerateFlowDiagram_Process">
			<listener className="nl.nn.adapterframework.receivers.JavaListener"
				name="WebControlGenerateFlowDiagram_Process" />
		</receiver>
		<pipeline firstPipe="doGenerateFlowDiagram">
			<exits>
				<exit state="success" path="EXIT" />
			</exits>

			<!-- INPUT (sessionKeys): method, restListenerServletContext, uri, configuration -->

			<pipe name="doGenerateFlowDiagram"
				className="nl.nn.adapterframework.webcontrol.pipes.GenerateFlowDiagram">
				<forward name="success" path="switchRoot" />
			</pipe>

			<pipe name="switchRoot" className="nl.nn.adapterframework.pipes.XmlSwitch"
				xpathExpression="name()='adapter'">
				<forward name="true" path="config2dot" />
				<forward name="false" path="ibis2dot" />
			</pipe>

			<pipe name="config2dot" className="nl.nn.adapterframework.pipes.XsltPipe"
				styleSheetName="GenerateFlowDiagram/xsl/config2dot.xsl" xslt2="true"
				storeResultInSessionKey="dotLines">
				<forward name="success" path="executeCommand" />
			</pipe>

			<pipe name="ibis2dot" className="nl.nn.adapterframework.pipes.XsltPipe"
				styleSheetName="GenerateFlowDiagram/xsl/ibis2dot.xsl" xslt2="true"
				storeResultInSessionKey="dotLines">
				<forward name="success" path="executeCommand" />
			</pipe>

			<pipe name="executeCommand"
				className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe">
				<sender className="nl.nn.adapterframework.http.HttpSender"
					methodType="POST" url="${createDiagram.url}" paramsInUrl="false"
					multipart="true" ignoreRedirects="true" verifyHostname="false"
					base64="true">
					<param name="outputFormat" value="svg" />
					<param name="dotLines" sessionKey="dotLines" />
				</sender>
				<forward name="success" path="EXIT" />
			</pipe>
		</pipeline>
	</adapter>

	<adapter name="WebControlGenerateFlowDiagram">
		<receiver className="nl.nn.adapterframework.receivers.GenericReceiver"
			name="WebControlGenerateFlowDiagram">
			<listener className="nl.nn.adapterframework.http.RestListener"
				name="WebControlGenerateFlowDiagram" uriPattern="generateFlowDiagram"
				view="false" />
		</receiver>
		<pipeline firstPipe="getCacheKey">
			<exits>
				<exit state="success" path="EXIT" />
			</exits>

			<pipe name="getCacheKey" className="nl.nn.adapterframework.pipes.XsltPipe"
				xpathExpression="concat($uri, '/', $config)" getInputFromFixedValue="&lt;dummy/&gt;"
				storeResultInSessionKey="cacheKey">
				<param name="uri" sessionKey="uri" />
				<param name="config" sessionKey="configuration" />
				<forward name="success" path="process" />
			</pipe>

			<pipe name="process"
				className="nl.nn.adapterframework.pipes.GenericMessageSendingPipe"
				streamResultToServlet="true">
				<sender className="nl.nn.adapterframework.senders.SenderWrapper">
					<cache keyInputSessionKey="cacheKey" maxElementsInMemory="1000" />
					<sender className="nl.nn.adapterframework.senders.IbisLocalSender"
						javaListener="WebControlGenerateFlowDiagram_Process">
						<param name="method" sessionKey="method" />
						<param name="restListenerServletContext" sessionKey="restListenerServletContext" />
						<param name="uri" sessionKey="uri" />
						<param name="configuration" sessionKey="configuration" />
					</sender>
				</sender>
				<forward name="success" path="EXIT" />
			</pipe>
		</pipeline>
	</adapter>
</module>